<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GYS: ref_cnt_ptr.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ref_cnt_ptr.h</h1><div class="fragment"><pre>00001 <span class="comment">// smart pointer by Phaton</span>
00002 
00009 <span class="preprocessor">#ifndef H_REFERENCE_COUNTING</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#define H_REFERENCE_COUNTING</span>
00011 <span class="preprocessor"></span>
00017 <span class="keyword">class </span>RefCntObject
00018 {
00019 <span class="keyword">public</span>:
00020   <span class="keyword">virtual</span> ~RefCntObject() {}
00021 
00025   RefCntObject() : m_refcnt(0) {}
00026 
00028   <span class="keywordtype">void</span> addRef() { m_refcnt++; }
00029 
00033   <span class="keywordtype">bool</span> subRef() { <span class="keywordflow">return</span> (--m_refcnt &lt;= 0); }
00034 
00035 <span class="keyword">private</span>:
00036   <span class="keywordtype">int</span> m_refcnt;
00037 };
00038 
00043 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
00044 <span class="keyword">class </span>RefCntPointer
00045 {
00046 <span class="keyword">public</span>:
00048   RefCntPointer(T* ptr=0) : m_ptr(ptr) { addRef(); }
00049   
00051   RefCntPointer(<span class="keyword">const</span> RefCntPointer&amp; p) : m_ptr(p.m_ptr) { addRef(); }
00052 
00054   ~RefCntPointer() { subRef(); }
00055 
00057   RefCntPointer&amp; operator= (<span class="keyword">const</span> RefCntPointer&amp; p)
00058   {
00059     <span class="keywordflow">return</span> *<span class="keyword">this</span> = p.m_ptr;
00060   }
00061 
00063   RefCntPointer&amp; operator= (T* ptr)
00064   {
00065     <span class="keywordflow">if</span> (m_ptr != ptr)
00066     {
00067       subRef();
00068       m_ptr=ptr;
00069       addRef();
00070     }
00071     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00072   }
00073 
00075   T&amp; operator *        ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> *m_ptr; }
00076 
00078   T* operator -&gt;       ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_ptr; }
00079 
00080   <span class="comment">// Conversion operators</span>
00081      operator T*       ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_ptr; }
00082      operator const T* ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_ptr; }
00083 
00085          operator bool     ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_ptr!=0; }
00086 
00088   T** operator &amp;       ()       { <span class="keywordflow">return</span> &amp;m_ptr; }
00089 
00090 <span class="keyword">private</span>:
00091   <span class="keywordtype">void</span> addRef()
00092   {
00093     <span class="comment">// Only change if non-null</span>
00094     <span class="keywordflow">if</span> (m_ptr) m_ptr-&gt;addRef();
00095   }
00096 
00097   <span class="keywordtype">void</span> subRef()
00098   {
00099     <span class="comment">// Only change if non-null</span>
00100     <span class="keywordflow">if</span> (m_ptr)
00101     {
00102       <span class="comment">// Subtract and test if this was the last pointer.</span>
00103           <span class="keywordflow">if</span> (m_ptr-&gt;subRef())
00104       {
00105         <span class="keyword">delete</span> m_ptr;
00106         m_ptr=0;
00107       }
00108     }
00109   }
00110 
00111   T* m_ptr;
00112 };
00113 
00114 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 7 13:56:03 2004 for GYS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
